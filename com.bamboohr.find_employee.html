<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>BambooHr Employee Select Widget</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  </head>
  <body>
    <div class="container">
        <form>
            <div class="form-group">
                <label for="selectEmployeeName" class="form-label">Employee Name</label>
                <div class="mb-3">
                    <!-- <select class="form-control basicAutoSelect" name="selectEmployeeName" data-url="https://jotform.lorenzbus.com/employees.json" placeholder="Type the employee's name..." autocomplete="off"></select> -->
                    <select class="form-control basicAutoSelect" name="selectEmployeeName" placeholder="Type the employee's name..." autocomplete="off"></select>
                    <small id="employeeHelp" class="form-text text-muted">Searching will begin when the third letter is typed.</small>
                </div>
            </div>
            <!-- development only -->
            <div class="form-group">
                <label for="labelCompanyDomain" class="form-label">Company Domain</label>
                <span id="labelCompanyDomain" class="form-text"></span><br/>
            </div>
            <div class="form-group">
                <label for="labelApiKey" class="form-label">API Key</label>
                <span id="labelApiKey" class="form-text"></span><br/>
            </div>
            <!-- /development only -->

            <!-- TODO: make hidden -->
            <div class="form-group">
                <label for="selectedEmployee" class="form-label">Selected Employee</label>
                <span id="selectedEmployee" class="form-text"></span>    
            </div>
            <!-- /TODO: make hidden -->
        </form>    
    </div>

    <script src="//code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- <script src="://code.jquery.com/jquery-3.6.3.min.js" integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin="anonymous"></script> -->
    <script src="//cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="//stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script> -->
    <script src="//cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <script src="com.bamboohr.api.js"></script>
    <script>
        $(function () {

            let companyDomain = null;
            let apiKey = null;
            let employees = [];

            //always subscribe to ready event and implement widget related code
            //inside callback function , it is the best practice while developing widgets
            JFCustomWidget.subscribe("ready", function(){

                companyDomain = JFCustomWidget.getWidgetSetting('companyDomain');
                // development only
                if (companyDomain) {
                    document.getElementById('labelCompanyDomain').textContent = companyDomain;
                }

                apiKey = JFCustomWidget.getWidgetSetting('apiKey');
                // development only
                if (apiKey) {
                    document.getElementById('labelApiKey').textContent = apiKey;
                }

                if (companyDomain && apiKey) {
                    employees = GetBambooHrEmployee(companyDomain,apiKey);
                    // employees.forEach(e => {
                    //     console.log('displayName',e.displayName);
                    // });
                }

                //subscribe to form submit event
                JFCustomWidget.subscribe("submit", function(){

                    // const employee = JSON.parse( $('#selectedEmployee')[0].innerHTML )
                    // console.log('employee',employee)

                    var msg = {
                        //you should valid attribute to data for JotForm
                        //to be able to use you widget as required
                        valid: true,
                        value: $('#selectedEmployee')[0].innerHTML
                        // value: document.getElementById('employeeInput').value
                    }

                    // send value to JotForm
                    JFCustomWidget.sendSubmit(msg);
                });

            });

            $('.basicAutoSelect').autoComplete({
                resolver: 'custom',
                formatResult: function (item) {
                    console.log('***** formatResult *****');
                    
                    return {
                        value: item.id,
                        text: item.displayName,
                        html: [ $('<img>').attr('src', item.photoUrl).css("height", 18), ' ', item.displayName ]
                    };
                },
                events: {
                    search: function (qry, callback) {
                        console.log('***** search *****');
                        console.log('qry',qry);

                        // console.log('companyDomain',companyDomain);
                        // console.log('apiKey',apiKey);

                        $.ajax({
                            // url: `https://api.bamboohr.com/api/gateway.php/${companyDomain}/v1/employees/directory`,
                            url: `https://jotform.${companyDomain}.com/com.bamboohr.employees.json`,
                            type: 'get',
                            headers: { 
                                Accept: 'application/json', 
                                Authorization: "Basic " + btoa(apiKey + ":password")
                            },
                        }).done(function (res) {
                            console.log('***** done *****');

                            /*
                            response:
                            {
                                "fields": [
                                    {
                                        "id": "displayName",
                                        "type": "text",
                                        "name": "Display name"
                                    },
                                    ...
                                ],
                                "employees": [
                                    {
                                        "id": "123",
                                        "displayName": "First Last",
                                        "firstName": "First",
                                        "lastName": "Last",
                                        "preferredName": null,
                                        "jobTitle": "Driver",
                                        "pronouns": null,
                                        "photoUploaded": true,
                                        "photoUrl": "https://images.bamboohr.com/123456/photos/123.jpg?...",
                                        "canUploadPhoto": 1
                                    },
                                    ...
                                ]
                            }
                            */

                            // res.employees.forEach(employee => {
                            //     console.log('employee',employee);
                            // });

                            // filter the list employees to match the search string
                            const employees = res.employees.filter( e => e.displayName.toLowerCase().includes(qry.toLowerCase()) );

                            // const regex = `^${qry}`
                            // const employees = res.employees.filter( e => e.displayName.match(regex) );

                            // assign results to select using its callback() method
                            callback(employees)
                        });
                    }
                }
            });

            // $('.basicAutoSelect').on('change', function (e) {
            //     console.log('***** change *****');
            // });

            /* when a select-list option has been chosen, save the JSON to the "selectedEmployee" element */
            $('.basicAutoSelect').on('autocomplete.select', function (evt, item) {
                console.log('***** autocomplete.select *****');

                $('#selectedEmployee').html(item?JSON.stringify(item):'null');

                // const employee = JSON.parse( $('#selectedEmployee')[0].innerHTML )
                // console.log('employee',employee)
            });

        });
    </script>
  </body>
</html>